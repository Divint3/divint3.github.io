document.addEventListener("DOMContentLoaded",()=>{let t=false;let n;let r=true;let e=CONFIG.path;if(e.length===0){e="search.xml"}else if(e.endsWith("json")){r=false}const l=document.querySelector(".search-input");const o=document.getElementById("search-result");const s=(t,e,n)=>{if(CONFIG.localsearch.unescape){let e=document.createElement("div");e.innerText=t;t=e.innerHTML}let r=t.length;if(r===0)return[];let l=0;let o=[];let s=[];if(!n){e=e.toLowerCase();t=t.toLowerCase()}while((o=e.indexOf(t,l))>-1){s.push({position:o,word:t});l=o+r}return s};const p=(e,t,n,r)=>{let l=n[n.length-1];let{position:o,word:s}=l;let i=[];let c=0;while(o+s.length<=t&&n.length!==0){if(s===r){c++}i.push({position:o,length:s.length});let e=o+s.length;n.pop();while(n.length!==0){l=n[n.length-1];o=l.position;s=l.word;if(e>o){n.pop()}else{break}}}return{hits:i,start:e,end:t,searchTextCount:c}};const f=(n,e)=>{let r="";let l=e.start;e.hits.forEach(e=>{r+=n.substring(l,e.position);let t=e.position+e.length;r+=`<b class="search-keyword">${n.substring(e.position,t)}</b>`;l=t});r+=n.substring(l,e.end);return r};const i=()=>{if(!t)return;let u=l.value.trim().toLowerCase();let e=u.split(/[-\s]+/);if(e.length>1){e.push(u)}let d=[];if(u.length>0){n.forEach(({title:l,content:i,url:o})=>{let t=l.toLowerCase();let n=i.toLowerCase();let c=[];let a=[];let h=0;e.forEach(e=>{c=c.concat(s(e,t,false));a=a.concat(s(e,n,false))});if(c.length>0||a.length>0){let e=c.length+a.length;[c,a].forEach(e=>{e.sort((e,t)=>{if(t.position!==e.position){return t.position-e.position}return e.word.length-t.word.length})});let t=[];if(c.length!==0){let e=p(0,l.length,c,u);h+=e.searchTextCountInSlice;t.push(e)}let s=[];while(a.length!==0){let e=a[a.length-1];let{position:t,word:n}=e;let r=t-20;let l=t+80;if(r<0){r=0}if(l<t+n.length){l=t+n.length}if(l>i.length){l=i.length}let o=p(r,l,a,u);h+=o.searchTextCountInSlice;s.push(o)}s.sort((e,t)=>{if(e.searchTextCount!==t.searchTextCount){return t.searchTextCount-e.searchTextCount}else if(e.hits.length!==t.hits.length){return t.hits.length-e.hits.length}return e.start-t.start});let n=parseInt(CONFIG.localsearch.top_n_per_article,10);if(n>=0){s=s.slice(0,n)}let r="";if(t.length!==0){r+=`<li><a href="${o}" class="search-result-title">${f(l,t[0])}</a>`}else{r+=`<li><a href="${o}" class="search-result-title">${l}</a>`}s.forEach(e=>{r+=`<a href="${o}"><p class="search-result">${f(i,e)}...</p></a>`});r+="</li>";d.push({item:r,id:d.length,hitCount:e,searchTextCount:h})}})}if(e.length===1&&e[0]===""){o.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'}else if(d.length===0){o.innerHTML='<div id="no-result"><i class="far fa-frown fa-5x"></i></div>'}else{d.sort((e,t)=>{if(e.searchTextCount!==t.searchTextCount){return t.searchTextCount-e.searchTextCount}else if(e.hitCount!==t.hitCount){return t.hitCount-e.hitCount}return t.id-e.id});o.innerHTML=`<ul class="search-result-list">${d.map(e=>e.item).join("")}</ul>`;window.pjax&&window.pjax.refresh(o)}};const c=()=>{fetch(CONFIG.root+e).then(e=>e.text()).then(e=>{t=true;n=r?[...(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("entry")].map(e=>{return{title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent}}):JSON.parse(e);n=n.filter(e=>e.title).map(e=>{e.title=e.title.trim();e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"";e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/");return e});document.getElementById("no-result").innerHTML='<i class="fa fa-search fa-5x"></i>';i()})};if(CONFIG.localsearch.preload){c()}if(CONFIG.localsearch.trigger==="auto"){l.addEventListener("input",i)}else{document.querySelector(".search-icon").addEventListener("click",i);l.addEventListener("keypress",e=>{if(e.key==="Enter"){i()}})}document.querySelectorAll(".popup-trigger").forEach(e=>{e.addEventListener("click",()=>{document.body.style.overflow="hidden";document.querySelector(".search-pop-overlay").classList.add("search-active");l.focus();if(!t)c()})});const a=()=>{document.body.style.overflow="";document.querySelector(".search-pop-overlay").classList.remove("search-active")};document.querySelector(".search-pop-overlay").addEventListener("click",e=>{if(e.target===document.querySelector(".search-pop-overlay")){a()}});document.querySelector(".popup-btn-close").addEventListener("click",a);window.addEventListener("pjax:success",a);window.addEventListener("keyup",e=>{if(e.key==="Escape"){a()}})});